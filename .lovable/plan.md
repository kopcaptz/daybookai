
# ТЗ: Расширение админ-панели Daybook

## Текущее состояние

Сейчас админка содержит только одну функцию — **Архив посланий** (управление фидбеком от пользователей). Это минимальный набор.

## Предлагаемые расширения

### 1. Главная страница админки с навигацией

Создать хаб `/admin/dashboard` с карточками-разделами:

```text
┌─────────────────────────────────────────────────────────────┐
│                     Портал Мастера                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ 📬 Послания │  │ 📊 Метрики  │  │ 🔧 Система  │          │
│  │   2 новых   │  │   Статы AI  │  │  Состояние  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│  ┌─────────────┐  ┌─────────────┐                           │
│  │ 📝 Логи     │  │ ⚙️ Настрой. │                           │
│  │  Диагност.  │  │  Админа     │                           │
│  └─────────────┘  └─────────────┘                           │
└─────────────────────────────────────────────────────────────┘
```

### 2. Страница метрик использования AI (Практично!)

**Цель**: Понимать, как используются AI-функции, какие модели работают, сколько запросов.

Данные для отображения:
- Общее количество вызовов AI (chat, biography, receipt, whisper)
- Разбивка по функциям
- Средняя длительность запросов
- Ошибки и их типы (401, 429, 500)
- Топ-5 популярных тем в чате (анонимизировано)

Требует: новую Edge Function `admin-ai-stats` для агрегации логов.

### 3. Страница системной диагностики

**Цель**: Проверка здоровья сервисов.

Показывает:
- Статус Edge Functions (ai-chat, ai-biography, etc.) — зелёный/красный
- Версия приложения
- Количество записей в базе feedback
- Размер бакета `feedback-attachments`
- Последняя активность

```text
┌────────────────────────────────────────────────────┐
│                 Состояние системы                   │
├────────────────────────────────────────────────────┤
│  ai-chat           ● Работает     42ms avg        │
│  ai-biography      ● Работает     1.2s avg        │
│  ai-receipt        ● Работает     890ms avg       │
│  ai-whisper        ● Работает     2.1s avg        │
│  feedback-submit   ● Работает     180ms avg       │
├────────────────────────────────────────────────────┤
│  Версия: 1.0.0                                     │
│  Посланий всего: 2                                 │
│  Последнее: 31 янв 2026, 17:06                     │
└────────────────────────────────────────────────────┘
```

### 4. Быстрые действия на странице фидбека

Добавить в текущий `AdminFeedbackPage`:
- **Массовые операции**: выбрать несколько → "Отметить как решённые"
- **Экспорт в CSV**: скачать все послания для анализа
- **Поиск по тексту**: фильтр по содержимому сообщений
- **Сортировка**: по дате, по статусу

### 5. Уведомление о новых посланиях

При входе в админку показывать баннер "У вас 2 новых послания" с быстрым переходом.

---

## Приоритеты реализации

| Приоритет | Функция | Сложность | Польза |
|-----------|---------|-----------|--------|
| 🔴 Высокий | Главная страница-хаб | Низкая | Навигация |
| 🔴 Высокий | Поиск и сортировка в фидбеке | Низкая | UX |
| 🟡 Средний | Системная диагностика | Средняя | Мониторинг |
| 🟡 Средний | Экспорт фидбека в CSV | Низкая | Отчётность |
| 🟢 Низкий | Метрики AI | Высокая | Аналитика |
| 🟢 Низкий | Массовые операции | Средняя | Удобство |

---

## Техническая реализация (первый этап)

### Новые файлы

```text
src/pages/
├── AdminDashboardPage.tsx    # Главная админки
├── AdminSystemPage.tsx       # Диагностика

supabase/functions/
├── admin-system-health/      # Проверка здоровья сервисов
```

### Изменения в существующих файлах

**`src/App.tsx`**:
- Добавить роуты `/admin/dashboard`, `/admin/system`
- Изменить `/admin` → редирект на `/admin/dashboard` после логина

**`src/pages/AdminLoginPage.tsx`**:
- После успешного логина → `/admin/dashboard` вместо `/admin/feedback`

**`src/pages/AdminFeedbackPage.tsx`**:
- Добавить поиск по тексту сообщений
- Добавить сортировку (новые/старые)
- Кнопка "Экспорт CSV"
- Хлебные крошки: Dashboard → Послания

### Структура главной страницы

```typescript
// AdminDashboardPage.tsx
const sections = [
  { 
    title: 'Послания', 
    icon: Mail, 
    path: '/admin/feedback',
    badge: newFeedbackCount,
    description: 'Фидбек от пользователей'
  },
  { 
    title: 'Система', 
    icon: Server, 
    path: '/admin/system',
    description: 'Диагностика сервисов'
  },
];
```

### Edge Function для здоровья системы

```typescript
// admin-system-health/index.ts
// Проверяет:
// 1. Подключение к базе (простой SELECT)
// 2. Счётчики таблицы feedback
// 3. Статистика бакета storage

return {
  database: 'ok',
  feedback: { total: 2, new: 0 },
  storage: { bucket: 'feedback-attachments', files: 1 },
  functions: ['ai-chat', 'ai-biography', ...],
  timestamp: Date.now()
};
```

---

## Итоговая структура админки

```text
/admin                    → Логин (PIN)
/admin/dashboard          → Главная (карточки разделов)
/admin/feedback           → Архив посланий + поиск + экспорт
/admin/system             → Диагностика системы
```

---

## Рекомендация

Начать с **первого этапа**:
1. Главная страница-хаб с карточками
2. Поиск и экспорт CSV на странице фидбека
3. Базовая страница диагностики

Это даёт максимум пользы при минимальных усилиях и создаёт основу для дальнейшего расширения.
