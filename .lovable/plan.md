

# ĞŸĞ»Ğ°Ğ½: Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ Weekly Insights

## ĞĞ±Ğ·Ğ¾Ñ€ Ğ·Ğ°Ğ´Ğ°Ñ‡

| # | Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° | ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ | Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ |
|---|--------|-----------|-----------|
| 1 | Ğ£ÑĞ¸Ğ»Ğ¸Ñ‚ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ | Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ | ĞĞ¸Ğ·ĞºĞ°Ñ |
| 2 | Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ñ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ | Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ | ĞĞ¸Ğ·ĞºĞ°Ñ |
| 3 | ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ½ÑĞ°Ğ¹Ñ‚Ğ° | ĞĞ¸Ğ·ĞºĞ¸Ğ¹ | ĞĞ¸Ğ·ĞºĞ°Ñ |

---

## Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° 1: Ğ£ÑĞ¸Ğ»Ğ¸Ñ‚ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°

Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ĞºĞ¾Ğ´ Ğ² `weeklyInsightsService.ts`:
```typescript
// Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° 46
return entries.filter(e => e.aiAllowed);
```

Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ (`biographyService`, `entryAnalysisService`) Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ Ğ±Ğ¾Ğ»ĞµĞµ ÑÑ‚Ñ€Ğ¾Ğ³ÑƒÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ:
```typescript
.filter(entry => !entry.isPrivate && entry.aiAllowed !== false)
```

### Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ

ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `getWeeklyEntries()` Ğ´Ğ»Ñ Ğ´Ğ²Ğ¾Ğ¹Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸:

```typescript
// src/lib/weeklyInsightsService.ts ÑÑ‚Ñ€Ğ¾ĞºĞ° 46
return entries.filter(e => !e.isPrivate && e.aiAllowed !== false);
```

**ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ ÑÑ‚Ğ¾ Ğ²Ğ°Ğ¶Ğ½Ğ¾:**
- Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ¼ĞµÑ‚Ğ¸Ñ‚ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ ĞºĞ°Ğº `isPrivate`, Ğ½Ğ¾ `aiAllowed` Ğ¾ÑÑ‚Ğ°Ğ½ĞµÑ‚ÑÑ `true` (edge case), Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑƒÑ‚ĞµÑ‡ÑŒ Ğ² AI
- Ğ”Ğ²Ğ¾Ğ¹Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ

---

## Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° 2: ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ñ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸

### ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ¨ Ğ ĞµĞ·Ğ¾Ğ½Ğ°Ğ½Ñ Ğ½ĞµĞ´ĞµĞ»Ğ¸                              [X]   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  ĞĞµĞ´ĞµĞ»Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° Ğ¿Ğ¾Ğ´ Ğ·Ğ½Ğ°ĞºĞ¾Ğ¼ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸...            â”‚
â”‚  ...                                                    â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ¯ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ:                                 â”‚   â”‚
â”‚  â”‚ ...                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: 2Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´ â€¢ 5 Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹                   â”‚
â”‚                                                         â”‚
â”‚  [â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â†» ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ

**1. src/lib/weeklyInsightsService.ts â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ forceRegenerate**

```typescript
export async function generateWeeklyInsight(
  language: 'ru' | 'en',
  forceRegenerate: boolean = false  // NEW parameter
): Promise<...>

export async function getOrGenerateWeeklyInsight(
  language: 'ru' | 'en',
  forceRegenerate: boolean = false  // NEW parameter
): Promise<...> {
  // Skip cache if forceRegenerate
  if (!forceRegenerate) {
    const cached = await getCachedWeeklyInsight();
    if (cached) {
      return { success: true, insight: cached, fromCache: true };
    }
  }
  // ... rest
}
```

**2. src/components/WeeklyInsightsWidget.tsx â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ**

```tsx
// ĞĞ¾Ğ²Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
const [isRefreshing, setIsRefreshing] = useState(false);

// ĞĞ¾Ğ²Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
const handleRefreshInsight = async () => {
  if (!hasValidToken) {
    openPinDialog();
    return;
  }
  
  setIsRefreshing(true);
  try {
    const result = await getOrGenerateWeeklyInsight(language, true); // force=true
    if (result.success === true) {
      setInsight(result.insight);
      toast.success(language === 'ru' ? 'ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾' : 'Refreshed');
    } else {
      // Handle errors...
    }
  } finally {
    setIsRefreshing(false);
  }
};

// Ğ’ Sheet Ğ¿Ğ¾ÑĞ»Ğµ meta info:
<Button
  variant="outline"
  size="sm"
  onClick={handleRefreshInsight}
  disabled={isRefreshing}
  className="w-full mt-3 text-xs gap-1.5"
>
  {isRefreshing ? (
    <Loader2 className="h-3 w-3 animate-spin" />
  ) : (
    <RefreshCw className="h-3 w-3" />
  )}
  {language === 'ru' ? 'ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ' : 'Refresh'}
</Button>
```

---

## Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° 3: ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸

### Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² WeeklyInsightsWidget.tsx

```tsx
// Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
function formatRelativeTime(timestamp: number, language: 'ru' | 'en'): string {
  const diff = Date.now() - timestamp;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  if (minutes < 1) return language === 'ru' ? 'Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾' : 'just now';
  if (minutes < 60) return language === 'ru' ? `${minutes}Ğ¼ Ğ½Ğ°Ğ·Ğ°Ğ´` : `${minutes}m ago`;
  if (hours < 24) return language === 'ru' ? `${hours}Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´` : `${hours}h ago`;
  return language === 'ru' ? `${days}Ğ´ Ğ½Ğ°Ğ·Ğ°Ğ´` : `${days}d ago`;
}

// ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ meta info
<p className="text-[10px] text-muted-foreground text-center">
  {language === 'ru' 
    ? `Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: ${formatRelativeTime(insight.generatedAt, language)} â€¢ ${insight.sourceEntryCount} Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹` 
    : `Generated: ${formatRelativeTime(insight.generatedAt, language)} â€¢ ${insight.sourceEntryCount} entries`}
</p>
```

---

## Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ

| Ğ¤Ğ°Ğ¹Ğ» | Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ |
|------|-----------|
| `src/lib/weeklyInsightsService.ts` | Ğ£ÑĞ¸Ğ»Ğ¸Ñ‚ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `forceRegenerate` Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ |
| `src/components/WeeklyInsightsWidget.tsx` | Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ", Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ |

---

## Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ UI

```text
Meta section Ğ² Sheet:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ...                                                    â”‚
â”‚                                                         â”‚
â”‚  Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: 2Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´ â€¢ 5 Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹                   â”‚
â”‚                                                         â”‚
â”‚  [â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â†» ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞŸĞ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ":**
- Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ 24Ñ‡ ĞºĞµÑˆ
- Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ ÑĞ²ĞµĞ¶Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· IndexedDB
- Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ AI Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
- ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ loading state Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
- ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ toast Ğ¿Ñ€Ğ¸ ÑƒÑĞ¿ĞµÑ…Ğµ/Ğ¾ÑˆĞ¸Ğ±ĞºĞµ

---

## ĞÑ†ĞµĞ½ĞºĞ°

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|----------|----------|
| Ğ’Ñ€ĞµĞ¼Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ | ~10 Ğ¼Ğ¸Ğ½ÑƒÑ‚ |
| Ğ Ğ¸ÑĞºĞ¸ | ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ |
| Ğ’Ğ»Ğ¸ÑĞ½Ğ¸Ğµ Ğ½Ğ° UX | Ğ£Ğ»ÑƒÑ‡ÑˆĞ°ĞµÑ‚ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ |

