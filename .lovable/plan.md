
# –§–∞–∑–∞ 3: Weekly Insights AI

## –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª—è–µ–º AI-powered –Ω–µ–¥–µ–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É: –∫–Ω–æ–ø–∫—É "–û–±–∑–æ—Ä –Ω–µ–¥–µ–ª–∏" –≤ `WeeklyInsightsWidget`, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–π Edge Function –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è, —Ç–µ–º –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –≤ —Å—Ç–∏–ª–µ "–∫–∏–±–µ—Ä-–≥—Ä–∏–º—É–∞—Ä–∞".

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞:

| Edge Function | Token Validation | –°—Ç–∞—Ç—É—Å |
|---------------|------------------|--------|
| `ai-chat` | ‚úÖ X-AI-Token + HMAC-SHA256 | –ó–∞—â–∏—â—ë–Ω |
| `ai-entry-analyze` | ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ | –£—è–∑–≤–∏–º (–¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ) |
| `ai-weekly-insights` | ‚úÖ –ù—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ | **–ù–æ–≤—ã–π** |

–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `ai-weekly-insights` –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤, —á—Ç–æ –∏ `ai-chat`.

## –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è

### 1. supabase/functions/ai-weekly-insights/index.ts

```typescript
// –ù–æ–≤—ã–π Edge Function –¥–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HMAC-SHA256 token validation (–∫–∞–∫ ai-chat)

interface WeeklyRequest {
  entries: Array<{
    date: string;
    mood: number;
    semanticTags: string[];
    title?: string;
  }>;
  language: 'ru' | 'en';
}

interface WeeklyResponse {
  summary: string;        // 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
  dominantThemes: string[]; // –¢–æ–ø-5 —Ç–µ–º
  moodPattern: string;    // –û–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
  insight: string;        // –ù–∞–±–ª—é–¥–µ–Ω–∏–µ
  suggestion: string;     // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
  requestId: string;
}

// –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ —Å—Ç–∏–ª–µ –∫–∏–±–µ—Ä-–º–∏—Å—Ç–∏—Ü–∏–∑–º–∞
const systemPrompt = `–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫ –ª–∏—á–Ω–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞ –≤ —Å—Ç–∏–ª–µ "–∫–∏–±–µ—Ä-–≥—Ä–∏–º—É–∞—Ä–∞".
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–µ–¥–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤—ã—è–≤–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã.

–°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞:
- –ò—Å–ø–æ–ª—å–∑—É–π –º–µ—Ç–∞—Ñ–æ—Ä—ã "–∫–æ–Ω—Ç—É—Ä–æ–≤", "—Ä–µ–∑–æ–Ω–∞–Ω—Å–æ–≤", "—Å–∏–≥–Ω–∞–ª–æ–≤"
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω, –Ω–æ –Ω–µ —Ü–∏—Ç–∏—Ä—É–π –∑–∞–ø–∏—Å–∏
- –§–æ–∫—É—Å –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö –∏ –∏–Ω—Å–∞–π—Ç–∞—Ö

JSON: {
  "summary": "2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ –Ω–µ–¥–µ–ª–µ",
  "dominantThemes": ["—Ç–µ–º–∞1", "—Ç–µ–º–∞2", ...],
  "moodPattern": "–æ–ø–∏—Å–∞–Ω–∏–µ –¥–∏–Ω–∞–º–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è",
  "insight": "–∫–ª—é—á–µ–≤–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ",
  "suggestion": "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è"
}`;
```

### 2. supabase/config.toml ‚Äî –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é

```toml
[functions.ai-weekly-insights]
verify_jwt = false
```

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 3. src/lib/db.ts ‚Äî –î–æ–±–∞–≤–∏—Ç—å WeeklyInsight storage

```typescript
// –ù–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Å–∞–π—Ç–æ–≤
export interface WeeklyInsight {
  weekStart: string;       // YYYY-MM-DD (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
  generatedAt: number;     // timestamp
  summary: string;
  dominantThemes: string[];
  moodPattern: string;
  insight: string;
  suggestion: string;
  sourceEntryCount: number;
}

// Dexie Version 14 —Å –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ–π
this.version(14).stores({
  // ... existing tables ...
  weeklyInsights: 'weekStart, generatedAt',
});
```

### 4. src/components/WeeklyInsightsWidget.tsx ‚Äî –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

**–î–æ–±–∞–≤–ª—è–µ–º—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ö–Ω–æ–ø–∫–∞ "–û–±–∑–æ—Ä –Ω–µ–¥–µ–ª–∏" (–≤–∏–¥–Ω–∞ –ø—Ä–∏ >= 3 –∑–∞–ø–∏—Å—è—Ö)
- Sheet —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∞–Ω–∞–ª–∏–∑–∞
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ IndexedDB
- –°–æ—Å—Ç–æ—è–Ω–∏—è: `isGenerating`, `showInsight`, `insight`

```tsx
// –ù–æ–≤—ã–π UI
{stats.entries7d >= 3 && (
  <Button
    variant="ghost"
    size="sm"
    onClick={handleGenerateInsight}
    disabled={isGenerating}
    className="mt-3 w-full text-xs text-cyber-glow hover:bg-cyber-glow/10"
  >
    {isGenerating ? <Loader2 /> : <Sparkles />}
    {language === 'ru' ? '–û–±–∑–æ—Ä –Ω–µ–¥–µ–ª–∏' : 'Week Summary'}
  </Button>
)}

// Sheet —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
<Sheet open={showInsight} onOpenChange={setShowInsight}>
  <SheetContent>
    <SheetHeader>
      <SheetTitle>‚ú® –†–µ–∑–æ–Ω–∞–Ω—Å –Ω–µ–¥–µ–ª–∏</SheetTitle>
    </SheetHeader>
    <div className="space-y-4 mt-4">
      {/* Summary */}
      <p className="text-sm">{insight?.summary}</p>
      
      {/* Dominant themes as tags */}
      <div>
        <h4 className="text-xs text-muted-foreground">–î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–µ –∫–æ–Ω—Ç—É—Ä—ã:</h4>
        <div className="flex flex-wrap gap-1 mt-1">
          {insight?.dominantThemes.map(t => <Badge key={t}>{t}</Badge>)}
        </div>
      </div>
      
      {/* Mood pattern */}
      <div>
        <h4 className="text-xs text-muted-foreground">–ü–∞—Ç—Ç–µ—Ä–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:</h4>
        <p className="text-sm">{insight?.moodPattern}</p>
      </div>
      
      {/* Insight card */}
      <div className="p-3 bg-cyber-glow/5 rounded-lg border border-cyber-glow/20">
        <h4 className="text-xs text-cyber-glow mb-1">üí° –ò–Ω—Å–∞–π—Ç:</h4>
        <p className="text-sm">{insight?.insight}</p>
      </div>
      
      {/* Suggestion card */}
      <div className="p-3 bg-primary/5 rounded-lg">
        <h4 className="text-xs text-primary mb-1">üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</h4>
        <p className="text-sm">{insight?.suggestion}</p>
      </div>
    </div>
  </SheetContent>
</Sheet>
```

### 5. src/lib/weeklyInsightsService.ts ‚Äî –ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å

```typescript
// –°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–¥–µ–ª—å–Ω—ã—Ö –∏–Ω—Å–∞–π—Ç–æ–≤

export async function generateWeeklyInsight(
  language: 'ru' | 'en'
): Promise<WeeklyInsight> {
  // 1. –°–æ–±—Ä–∞—Ç—å –∑–∞–ø–∏—Å–∏ –∑–∞ 7 –¥–Ω–µ–π
  // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ—à (–ø–æ–≤—Ç–æ—Ä–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑ –≤ 24—á)
  // 3. –í—ã–∑–≤–∞—Ç—å ai-weekly-insights —Å X-AI-Token
  // 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ IndexedDB
  // 5. –í–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
}

export async function getCachedWeeklyInsight(): Promise<WeeklyInsight | null> {
  // –ü–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–µ—à–∞ –µ—Å–ª–∏ —Å–≤–µ–∂–∏–π (<24—á)
}
```

## –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ù–µ–¥–µ–ª—è                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ  ‚îÇ üìö 7 ‚îÇ ‚îÇ üòä4.2‚îÇ ‚îÇ üî• 5 ‚îÇ ‚îÇ üîî 2 ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ –ó–∞–ø–∏—Å–µ–π‚îÇ ‚îÇ Mood ‚îÇ ‚îÇStreak‚îÇ ‚îÇRemind‚îÇ                  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  [‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ú® –û–±–∑–æ—Ä –Ω–µ–¥–µ–ª–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ]               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Sheet (–ø—Ä–∏ –∫–ª–∏–∫–µ):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚ú® –†–µ–∑–æ–Ω–∞–Ω—Å –Ω–µ–¥–µ–ª–∏                              [X]   ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    ‚îÇ
‚îÇ  –ù–µ–¥–µ–ª—è –ø—Ä–æ—à–ª–∞ –ø–æ–¥ –∑–Ω–∞–∫–æ–º –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.              ‚îÇ
‚îÇ  –ö–æ–Ω—Ç—É—Ä—ã —Ä–∞–±–æ—Ç—ã –∏ —Å–µ–º—å–∏ –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–ª–∏ –≤ —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç–æ–∫–µ.   ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  –î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–µ –∫–æ–Ω—Ç—É—Ä—ã:                                  ‚îÇ
‚îÇ  [—Ä–∞–±–æ—Ç–∞] [—Å–µ–º—å—è] [–ø—Ä–æ–µ–∫—Ç] [–æ—Ç–¥—ã—Ö]                     ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  –ü–∞—Ç—Ç–µ—Ä–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:                                    ‚îÇ
‚îÇ  –í–æ—Å—Ö–æ–¥—è—â–∞—è –¥–∏–Ω–∞–º–∏–∫–∞: –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ –Ω–∞ 3.2,            ‚îÇ
‚îÇ  –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞ 4.5. –ü—è—Ç–Ω–∏—Ü–∞ ‚Äî –ø–∏–∫ —Ä–µ–∑–æ–Ω–∞–Ω—Å–∞.           ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ üí° –ò–Ω—Å–∞–π—Ç:                                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ –ó–∞–º–µ—á–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω: –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–µ —É—Ç—Ä–∞ –ø–æ–≤—ã—à–∞—é—Ç     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ –≤–µ—á–µ—Ä–Ω–∏–π —Ä–µ–∑–æ–Ω–∞–Ω—Å. –ë–ª–æ–∫–∏ —Ä–∞–±–æ—Ç—ã –¥–æ 14:00        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—Ç —Å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –¥–Ω—è.       ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:                                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π 15-–º–∏–Ω—É—Ç–Ω—É—é –ø–∞—É–∑—É –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–Ω—è     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞.        ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Flow –¥–∏–∞–≥—Ä–∞–º–º–∞

```text
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç "–û–±–∑–æ—Ä –Ω–µ–¥–µ–ª–∏"
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ—à (IndexedDB) ‚îÇ
‚îÇ weeklyInsights[weekStart] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚îú‚îÄ‚îÄ‚îÄ –°–≤–µ–∂–∏–π (<24—á) ‚îÄ‚îÄ‚ñ∫ –ü–æ–∫–∞–∑–∞—Ç—å –∏–∑ –∫–µ—à–∞
        ‚îÇ
        ‚ñº (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π/–Ω–µ—Ç)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å AI Token        ‚îÇ
‚îÇ isAITokenValid()          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚îú‚îÄ‚îÄ‚îÄ –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π ‚îÄ‚îÄ‚ñ∫ –ü–æ–∫–∞–∑–∞—Ç—å PIN –¥–∏–∞–ª–æ–≥
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–æ–±—Ä–∞—Ç—å entries –∑–∞ 7 –¥–Ω–µ–π ‚îÇ
‚îÇ db.entries.where(date)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –í—ã–∑–≤–∞—Ç—å Edge Function     ‚îÇ
‚îÇ ai-weekly-insights        ‚îÇ
‚îÇ + X-AI-Token header       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–µ—à           ‚îÇ
‚îÇ db.weeklyInsights.put()   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
    –ü–æ–∫–∞–∑–∞—Ç—å Sheet
```

## –û—Ü–µ–Ω–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –¢–æ–∫–µ–Ω–æ–≤ –Ω–∞ –∑–∞–ø—Ä–æ—Å | ~500 |
| –ó–∞–ø—Ä–æ—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é | 1-2 –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| –°—Ç–æ–∏–º–æ—Å—Ç—å | ~$0.0007/–Ω–µ–¥–µ–ª—é |
| Latency | <1s (gemini-2.5-flash) |

## Edge Cases

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|----------|-----------|
| < 3 –∑–∞–ø–∏—Å–µ–π | –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∞ |
| AI Token –∏—Å—Ç—ë–∫ | –ü–æ–∫–∞–∑–∞—Ç—å PIN –¥–∏–∞–ª–æ–≥ |
| Offline | –ü–æ–∫–∞–∑–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ disabled |
| –í—Å–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ | –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∞ |
| Rate limit | Toast —Å –æ—à–∏–±–∫–æ–π, retry —á–µ—Ä–µ–∑ 30s |
| –°–≤–µ–∂–∏–π –∫–µ—à | –ü–æ–∫–∞–∑–∞—Ç—å –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ API |

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. –°–æ–∑–¥–∞—Ç—å Edge Function `ai-weekly-insights` —Å token validation
2. –û–±–Ω–æ–≤–∏—Ç—å `supabase/config.toml`
3. –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å `weeklyInsightsService.ts`
4. –î–æ–±–∞–≤–∏—Ç—å DB Version 14 —Å —Ç–∞–±–ª–∏—Ü–µ–π `weeklyInsights`
5. –û–±–Ω–æ–≤–∏—Ç—å `WeeklyInsightsWidget.tsx` —Å –∫–Ω–æ–ø–∫–æ–π –∏ Sheet
6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
