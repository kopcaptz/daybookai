

# План: Облачная синхронизация записей дневника

## Куда сохранятся изменения?
Все изменения будут автоматически записаны в репозиторий **kopcaptz/daybookai** (ветка `main`) на GitHub. Cursor увидит обновления при следующем `git pull`. Ветка `cursor/daybookai-e970` останется отдельной -- её можно будет удалить после завершения, чтобы не было конфликтов.

---

## Обзор архитектуры

Сейчас все личные данные (записи, вложения, черновики, биографии, напоминания, чеки, обсуждения) хранятся **только локально** в IndexedDB через Dexie.js (14 таблиц, schema v15). Единственный способ перенести данные -- ручной ZIP-бэкап.

Цель: добавить **облачную синхронизацию**, сохранив **offline-first** поведение. Локальная база останётся основной, облако будет зеркалом для доступа с других устройств.

```text
+------------------+       +------------------+       +------------------+
|   Устройство A   |       |     Облако       |       |   Устройство B   |
|                  |       |   (Lovable Cloud)|       |                  |
|  IndexedDB       | <---> |  diary_entries    | <---> |  IndexedDB       |
|  (Dexie v15)     |       |  diary_attach.    |       |  (Dexie v15)     |
|                  |       |  + Storage bucket |       |                  |
+------------------+       +------------------+       +------------------+
```

---

## Этапы реализации

### Этап 1: Аутентификация пользователя

Без аутентификации синхронизация невозможна -- нужно знать, кому принадлежат данные.

**Что будет сделано:**
- Страница `/auth` с формами входа и регистрации (email + пароль)
- Автоматический редирект авторизованных пользователей на главную
- Неавторизованные пользователи продолжают пользоваться приложением локально (как сейчас)
- Кнопка "Войти для синхронизации" в настройках

**Важно:** синхронизация -- опциональна. Без регистрации приложение работает как раньше.

### Этап 2: Облачные таблицы (миграция базы данных)

Создание таблиц в Lovable Cloud для хранения серверной копии данных:

**Таблица `diary_entries`:**
| Поле | Тип | Описание |
|------|------|----------|
| id | uuid | PK, генерируется сервером |
| user_id | uuid | Привязка к пользователю |
| local_id | integer | Локальный ID из IndexedDB |
| date | text | YYYY-MM-DD |
| text | text | Текст записи (зашифрован в будущем) |
| mood | smallint | 1-5 |
| tags | text[] | Теги |
| is_private | boolean | Приватность |
| title | text | Заголовок |
| title_source | text | 'ai' или 'user' |
| mood_source | text | 'ai' или 'user' |
| semantic_tags | text[] | AI-теги |
| attachment_counts | jsonb | Счётчики вложений |
| created_at | timestamptz | Время создания |
| updated_at | timestamptz | Время обновления |
| deleted_at | timestamptz | Soft delete для конфликтов |

**Таблица `diary_attachments`:**
| Поле | Тип | Описание |
|------|------|----------|
| id | uuid | PK |
| user_id | uuid | Владелец |
| entry_id | uuid | FK на diary_entries |
| local_entry_id | integer | Локальный ID записи |
| kind | text | image / video / audio |
| mime_type | text | MIME-тип |
| size | integer | Размер в байтах |
| duration | integer | Для аудио/видео |
| storage_path | text | Путь в Storage bucket |
| thumbnail_path | text | Путь к превью |
| created_at | timestamptz | Время создания |

**RLS-политики:** Все таблицы будут защищены RLS -- пользователь видит только свои данные (`auth.uid() = user_id`).

**Storage bucket:** `diary-media` -- приватный бакет для вложений.

### Этап 3: Сервис синхронизации

Логика синхронизации на клиенте:

**Стратегия: "Last Write Wins" с soft-delete**
- Каждая запись имеет `updated_at` -- при конфликте побеждает более свежая версия
- Удалённые записи помечаются `deleted_at` вместо физического удаления
- Sync выполняется при подключении к сети и периодически (каждые 5 минут)

**Файл `src/lib/syncService.ts`:**
- `syncEntries()` -- двусторонняя синхронизация записей
- `syncAttachments()` -- загрузка/скачивание медиа через Storage
- `fullSync()` -- полная синхронизация всех данных
- `migrateLegacyData()` -- одноразовая выгрузка существующих локальных данных в облако

**Алгоритм синхронизации:**
1. Получить все записи с сервера, где `updated_at` > последней синхронизации
2. Получить все локальные записи, изменённые после последней синхронизации
3. Сравнить по `updated_at` -- более свежая версия побеждает
4. Применить изменения в обе стороны
5. Сохранить метку последней синхронизации

### Этап 4: Расширение локальной схемы Dexie (v16)

Добавить поля для синхронизации в локальную базу:

- `cloudId` (uuid) -- ID записи в облаке (null если не синхронизирована)
- `syncStatus` ('synced' | 'pending' | 'conflict') -- статус синхронизации
- `lastSyncedAt` (timestamp) -- время последней синхронизации

### Этап 5: UI-интеграция

**В настройках (`SettingsPage`):**
- Статус синхронизации (последнее время, количество несинхронизированных записей)
- Кнопка "Синхронизировать сейчас"
- Кнопка "Выйти из аккаунта" (при выходе данные остаются локально)
- Переключатель "Синхронизировать приватные записи" (по умолчанию выключен)

**Визуальные индикаторы:**
- Иконка облака в карточке записи (синхронизирована / ожидает / ошибка)
- Индикатор в хедере при активной синхронизации

### Этап 6: Первоначальная миграция

При первом входе в аккаунт:
- Диалог "Загрузить существующие записи в облако?"
- Прогресс-бар загрузки (записи, затем вложения)
- Возможность отменить до завершения

---

## Что НЕ будет синхронизироваться (на первом этапе)

- Черновики (drafts) -- локальны по определению
- Биографии -- можно перегенерировать
- Обсуждения (discussions) -- локальная AI-функция
- Очередь анализа -- техническая таблица
- Логи сканирования -- диагностика
- Еженедельные инсайты -- можно перегенерировать

Только **записи (entries)** и **вложения (attachments)** синхронизируются.

---

## Приватность и безопасность

- Записи с `isPrivate: true` по умолчанию **не синхронизируются** (опция в настройках)
- RLS-политики гарантируют доступ только к своим данным
- Вложения хранятся в приватном bucket с доступом через signed URLs

---

## Порядок реализации

1. **Аутентификация** -- страница /auth, хук useAuth, защита маршрутов
2. **Миграция БД** -- создание таблиц diary_entries, diary_attachments, storage bucket
3. **Dexie v16** -- добавление cloudId, syncStatus в локальную схему
4. **syncService** -- ядро синхронизации с конфликт-резолюцией
5. **UI** -- индикаторы, настройки, миграция данных
6. **Тестирование** -- проверка на двух устройствах

---

## Технические детали

**Новые файлы:**
- `src/pages/AuthPage.tsx` -- страница входа/регистрации
- `src/lib/syncService.ts` -- логика синхронизации
- `src/hooks/useAuth.ts` -- хук для аутентификации
- `src/hooks/useSync.ts` -- хук для управления синхронизацией
- `src/components/SyncIndicator.tsx` -- индикатор статуса синхронизации

**Модифицированные файлы:**
- `src/lib/db.ts` -- Dexie v16 с cloudId/syncStatus
- `src/App.tsx` -- добавление маршрута /auth, AuthProvider
- `src/pages/SettingsPage.tsx` -- секция синхронизации
- `src/components/EntryCard.tsx` -- индикатор облака

**Серверная сторона:**
- Миграция SQL для таблиц diary_entries и diary_attachments
- Storage bucket `diary-media`
- Edge function `sync-entries` для batch-синхронизации (опционально, можно через прямой Supabase SDK)

