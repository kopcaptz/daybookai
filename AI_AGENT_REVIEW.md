# Анализ логики ИИ-агента в дневнике (DaybookAI)

## Обзор архитектуры

Приложение использует **серверные Edge Functions (Supabase/Deno)** для всех AI-вызовов, а клиент является тонким слоем — он не хранит API-ключей и работает через PIN-авторизацию с HMAC-токеном.

### Компоненты AI-системы

| Компонент | Edge Function | Клиентский сервис | Модель по умолчанию |
|-----------|---------------|-------------------|---------------------|
| Чат (Sigil) | `ai-chat` | `aiService.ts` | gemini-3-flash-preview |
| Анализ записей | `ai-entry-analyze` | `entryAnalysisService.ts` | gemini-2.5-flash-lite |
| Биография дня | `ai-biography` | `biographyService.ts` | gemini-2.5-pro |
| Сканер чеков | `ai-receipt` | `receiptService.ts` | gemini-2.5-pro |
| Еженедельные инсайты | `ai-weekly-insights` | `weeklyInsightsService.ts` | gemini-2.5-flash |
| Транскрибация | `ai-transcribe` | (клиент напрямую) | gemini-2.5-flash |
| Шёпот Оракула | `ai-whisper` | (клиент напрямую) | gemini-3-flash-preview |
| Анализ изображений | `ai-chat` (мультимодал) | `imageAnalysisService.ts` | зависит от профиля |
| Тест соединения | `ai-test` | `aiService.ts` | gemini-3-flash-preview |
| PIN-верификация | `ai-pin-verify` | `aiTokenService.ts` | — |

---

## 1. Система безопасности и доступа

### Что реализовано хорошо (EFFECTIVE)

**PIN + HMAC Token авторизация:**
- 4-значный PIN → сервер проверяет через HMAC-SHA256 → выдаёт подписанный токен на 7 дней
- Токен содержит `exp` timestamp, проверяется на каждом запросе
- Constant-time сравнение PIN-хешей (защита от timing attack)
- Rate limiting: 5 попыток → блокировка на 15 минут (серверный + клиентский)
- Токен хранится в `localStorage`, автоматическое обновление проверки каждые 60 сек

**Auto-retry на 401:**
- Единая система `aiAuthRecovery.ts` — при 401 автоматически показывает PIN-диалог
- Concurrency-safe: несколько параллельных 401 разделяют один и тот же PIN-промис
- Максимум 1 retry на запрос

### Проблемы и рекомендации

**ПРОБЛЕМА 1: `ai-entry-analyze` НЕ использует AI Token авторизацию**
- Файл `supabase/functions/ai-entry-analyze/index.ts` использует `Access-Control-Allow-Origin: *` и НЕ проверяет `X-AI-Token`
- Клиент вызывает через `supabase.functions.invoke()` (стандартный Supabase auth), а не через fetch с `X-AI-Token`
- Это единственная AI-функция без PIN-защиты — потенциально любой с Supabase anon key может вызывать анализ записей
- **Рекомендация:** Добавить `validateAIToken` в `ai-entry-analyze`, как во всех остальных функциях

**ПРОБЛЕМА 2: `ai-whisper` НЕ использует AI Token авторизацию**
- Аналогично, `ai-whisper` не проверяет `X-AI-Token` и использует `CORS: *`
- Любой может генерировать "шёпот Оракула" без PIN
- **Рекомендация:** Добавить `validateAIToken` (хотя это менее критично, т.к. генерирует только 1 фразу)

**ПРОБЛЕМА 3: `ai-entry-analyze` использует `Access-Control-Allow-Origin: *`**
- Все остальные AI-функции используют whitelist origins — это функция является исключением
- **Рекомендация:** Перейти на whitelist CORS как в остальных функциях

---

## 2. Приватность и работа с данными

### Что реализовано хорошо (EFFECTIVE)

**Многоуровневая приватность:**
1. **`isPrivate` записи** — приватные записи полностью исключены из AI:
   - Не передаются в чат-контекст
   - Не анализируются (`entryAnalysisService`)
   - Не включаются в биографию дня
   - Не включаются в еженедельные инсайты

2. **`aiAllowed` per-entry** — пользователь может отключить AI для конкретной записи, даже если она не приватная

3. **`strictPrivacy` mode** — при включении (по умолчанию ON):
   - Тексты записей НИКОГДА не передаются AI дословно
   - Вместо этого используется `paraphraseText()` — локальное извлечение тем ("работа", "семья", "здоровье")
   - Биография дня получает только **обобщённые темы и настроение**, не сырой текст
   - Сканер чеков блокируется при `strictPrivacy: true` (корректно)

4. **Биография дня — безопасная по дизайну:**
   - `biographyService.ts` → `extractThemes()` работает ЛОКАЛЬНО, без AI
   - На сервер отправляются только: timeLabel, mood (1-5), themes (ключевые слова), tags, attachmentCount
   - Промпт явно запрещает: цитирование, выдумывание фактов, упоминание конкретных людей/мест
   - Это **отличный паттерн приватности**

5. **Еженедельные инсайты** — отправляется только `text.slice(0, 100)` как превью, не полный текст

### Проблемы

**ПРОБЛЕМА 4: `ai-entry-analyze` получает ПОЛНЫЙ текст записи**
- `entryAnalysisService.ts` (строка 160): `callAnalyzeEdgeFunction(entry.text, entry.tags, item.language)` — отправляет полный текст
- Edge function обрезает до 1000 символов, но это всё ещё значительно больше чем "темы"
- Настройка `strictPrivacy` НЕ влияет на эту функцию
- **Рекомендация:** При `strictPrivacy: true` — либо отключить анализ, либо отправлять только темы (как в биографии)

**ПРОБЛЕМА 5: Weekly insights отправляет превью текста**
- `weeklyInsightsService.ts` строка 109: `text: e.text.slice(0, 100)` — 100 символов для каждой записи
- При `strictPrivacy` это не блокируется
- **Рекомендация:** Учитывать `strictPrivacy` — при включении отправлять только `semanticTags` и `mood`

---

## 3. Модели и профили

### Что реализовано хорошо (EFFECTIVE)

**Гибкая система профилей:**
- 5 профилей: economy, fast, balanced, quality, biography
- Раздельные профили для чата и биографии
- Легаси маппинг GPT → Gemini для обратной совместимости
- Все модели Google Gemini (2.5-flash-lite, 2.5-flash, 2.5-pro, 3-flash-preview)

**Оптимизация по задачам:**
- Быстрый анализ настроения: `gemini-2.5-flash-lite`, max_tokens=50, temp=0.2
- Полный анализ записи: `gemini-2.5-flash-lite`, max_tokens=300, temp=0.3
- Биография: `gemini-2.5-pro`, max_tokens=3072, temp=0.8
- Чеки: `gemini-2.5-pro`, max_tokens=4096, temp=0.1
- Чат: настраиваемый пользователем (256–2048 tokens)

### Замечание

**ЗАМЕЧАНИЕ 6: Нет контроля расходов (cost budget)**
- Нет ограничения на количество запросов в день/неделю на пользователя
- Каждый чат-запрос, биография, анализ — это отдельный API-вызов
- Rate limit только со стороны AI-провайдера (429), нет собственного лимита
- **Рекомендация:** Добавить daily/weekly request quota (хотя бы клиентскую)

---

## 4. Обработка ошибок и устойчивость

### Что реализовано хорошо (EFFECTIVE)

**Retry-логика:**
- Биография и чеки: 1 retry с 1000ms задержкой на 5xx ошибки
- Analysis queue: 3 попытки с сохранением в IndexedDB для offline retry
- Rate limit delay 500ms между пакетными запросами анализа
- SSE stream parsing с буферизацией и graceful обработкой неполных чанков

**JSON extraction (биография):**
- `extractJSON()` — продвинутый парсер с обнаружением truncation
- Анализ баланса скобок, определение обрезанного ответа
- Корректный HTTP-код: 502 для truncation, 500 для parse error
- Валидация структуры через `isValidBiographyShape()`

**Fallback-цепочки API:**
- LOVABLE_API_KEY → OPENROUTER_API_KEY → ошибка "not configured"
- Маппинг моделей для совместимости

### Проблемы

**ПРОБЛЕМА 7: `ai-entry-analyze` не имеет retry-логики**
- В отличие от biography и receipt, эта функция не ретраит на 5xx
- Клиент имеет очередь retry, но серверная сторона — нет
- **Рекомендация:** Добавить 1 retry на 5xx как в biography/receipt

**ПРОБЛЕМА 8: `ai-weekly-insights` не имеет retry-логики**
- Ни серверной, ни клиентской
- При ошибке пользователь должен вручную обновить
- **Рекомендация:** Добавить клиентскую retry (cache + offline queue)

---

## 5. Промпт-инжениринг

### Что реализовано хорошо (EFFECTIVE)

**Биография дня (лучший промпт в системе):**
- Строгие правила: НЕ цитировать, НЕ выдумывать, НЕ упоминать людей
- Ограниченный словарь техно-мистических терминов (контур, резонанс, калибровка)
- Запрещённые термины (магия, таро, астрология)
- Пропорция: 80% ясный русский, 20% стилистика
- Confidence-уровни (low/medium/high) на основе количества данных
- Адаптивная длина narrative (3-6 vs 6-12 предложений)
- Поддержка 4 языков (ru, en, he, ar)

**Чат-агент (Sigil):**
- Мультиязычный: определяет язык пользователя и отвечает на нём
- Правила: не цитировать записи, не раскрывать персональные детали
- Vision capability для анализа изображений

**Анализ записей:**
- Двойной режим: quick (50 tokens, ~200ms) и full (300 tokens)
- Quick используется для live-предсказания настроения во время набора
- Генерация заголовка в стиле "кибер-мистицизма"

### Замечания

**ЗАМЕЧАНИЕ 9: Чат не имеет ограничения по контексту**
- `retrieveRelevantEntries()` возвращает до 5 записей в контекст
- Каждая запись может быть до 100 символов (или "тема" при strictPrivacy)
- Но system prompt + 50 сообщений чата + контекст — может превысить контекстное окно
- **Рекомендация:** Добавить подсчёт токенов и обрезку контекста

---

## 6. Разрешения AI-агента (резюме)

### Что агент МОЖЕТ делать сейчас:

| Действие | Требует PIN | Учитывает strictPrivacy | Учитывает isPrivate | Учитывает aiAllowed |
|----------|-------------|------------------------|--------------------|--------------------|
| Чат с ассистентом | Да | Да (перифраз) | Да (исключает) | Да |
| Анализ настроения записи | **Нет** | **Нет** | Да | Да |
| Генерация заголовка | **Нет** | **Нет** | Да | Да |
| Семантические теги | **Нет** | **Нет** | Да | Да |
| Биография дня | Да | Да (только темы) | Да (исключает) | Да |
| Сканер чеков | Да | Да (блокирует) | — | — |
| Еженедельные инсайты | Да | **Нет** (100 символов) | Да (исключает) | Да |
| Транскрибация аудио | Да | — | — | — |
| Анализ изображений | Да | — | — | — |
| Шёпот Оракула | **Нет** | — | — | — |

### Что НЕ хватает (рекомендации по расширению разрешений):

1. **PIN-защита для `ai-entry-analyze`** — самая критичная проблема. Эта функция отправляет полный текст записи и не требует AI-токена.

2. **Учёт `strictPrivacy` в анализе записей** — при `strictPrivacy: true` анализ не должен отправлять полный текст, а только локально извлечённые темы.

3. **Учёт `strictPrivacy` в еженедельных инсайтах** — не должен отправлять даже 100 символов превью.

4. **Rate limiting собственный** — ограничение 429 только от AI-провайдера, нет собственных лимитов по количеству запросов.

---

## 7. Общая оценка

### Эффективность: 7.5/10

**Сильные стороны:**
- Отличная архитектура приватности для биографии (данные никогда не покидают устройство в сыром виде)
- Продвинутая PIN + HMAC токенная система с rate limiting
- Грамотная обработка ошибок с retry queue для offline
- Продуманные промпты с ограничениями и стилистикой
- Мультиязычность (ru/en/he/ar)
- Разделение профилей (экономия vs качество)

**Требует внимания:**
- 2 функции (`ai-entry-analyze`, `ai-whisper`) обходят PIN-авторизацию
- `strictPrivacy` не полностью покрывает все AI-функции
- Нет собственного rate limiting / budget control
- `ai-entry-analyze` использует `CORS: *`

### Итог

Агент **эффективен** для основных сценариев (чат, биография, чеки, транскрибация). Система приватности биографии — образцовая. Однако есть **2 критичные дыры в авторизации** (`ai-entry-analyze` и `ai-whisper` без PIN), которые нужно закрыть в первую очередь. Также стоит распространить `strictPrivacy` на анализ записей и еженедельные инсайты для полноценной защиты.
